---
title: JVM中的即时编译
date: 2017-09-09 09:19:51
categories: 
	- JVM
tags:
	- JVM
---

JVM中的即时编译学习。

<!--more-->

- 解释器：Java源程序编译成字节码后，运行时环境对字节码进行解释执行，提供解释执行的组件就是解释器interpreter。执行方式是一边翻译一边执行，效率低，但是简单易于实现
- 即时编译器（JIT编译器）：运行时程序执行频繁的代码称为热点代码，JVM使用即时编译器将热点代码编译成本地代码。Hotspot中有客户端编译器（C1编译器）和服务端编译器（C2编译器），C1编译速度快，C2会进行更多优化，C2编译比C1耗时

Hotspot提供了三种运行模式：

- 解释模式，`-Xint`选项指定，JVM使用解释模式运行
- 编译模式，`-Xcomp`选项指定，JVM使用编译模式运行
- 混合模式，`-Xmixed`选项指定，JVM以解释加编译模式运行，Hotspot默认是混合模式

# 即时编译器

Hotspot中即时编译器包括客户端（C1）编译器和服务端（C2）编译器，其中C1编译器编译速度快，C2编译器做的优化多耗时多能产生更高效代码。

解释器可以和C1、C2编译器协同运行，进行多级编译：

- 第0级，CompLevel_none，采用解释器解释执行，不采集性能监控数据，可升级到第1级
- 第1级，CompLevel_simple，采用C1编译器，会把热点代码快速编译成本地代码，不开启性能监控
- 第2级，CompLevel_limited_profile，采用C1编译器，仅开启方法次数统计和回边次数统计等有限的性能监控功能
- 第3级，CompLevel_full_profile，采用C1编译器，开启全部性能监控，采集性能数据进行优化措施，包括：方法次数统计、回边次数统计、手机分支跳转统计、虚方法调用版本统计信息
- 第4级，CompLevel_full_optimization，采用C2编译器，进行完全的优化，根据性能监控信息进行一些不可靠的激进优化

# 栈上替换

热点代码包括：

- 被多次调用的方法
- 被多次执行的循环体

被多次调用的方法，依靠方法调用触发编译，编译器会以整个方法作为编译对象。

被多次执行的循环体，热点代码只是方法的一部分，但编译器必须对整个方法作为编译对象，只是执行入口会有不同，编译时会传入执行入口字节码序号，这种在方法执行过程中就进行编译的方式成为栈上替换（On Stack Replacement，OSR）

# 热点探测

热点探测用来判断某段代码是不是热点代码，是不是需要触发即时编译。有两种判定方式：

- 基于采样的热点探测，周期性检查各个线程栈顶，如果发现某个方法经常出现在栈顶，就可以认为是热点方法。实现简单高效，可以容易获取方法调用关系，但是容易受线程阻塞或别的外界因素的影响而扰乱热点探测
- 基于计数器的热点探测，JVM会为每个方法建立计数器，统计方法执行次数，如果超过了阈值就可以认为是热点方法，统计更精确，但是实现麻烦，不能直接获取到方法调用关系

Hotspot虚拟机采用基于计数器的热点探测方法，有两类计数器：

- 方法调用计数器，用来统计方法被调用次数
- 回边计数器，用来统计方法中循环体的代码执行次数

## 方法调用计数器

方法调用计数器，用来统计方法被调用的次数。默认设置下并不是统计的方法被调用的绝对次数，而是一个相对次数，即一段时间之内方法被调用次数。当超过一定的时间限度，如果方法的调用次数仍不足触发即时编译，则该方法的调用技术器就会减少一半，这个过程称为方法调用技术器热度衰减，这段时间称为此方法统计的半衰周期。热度衰减是在虚拟机进行垃圾收集时进行的。

可使用`-XX:-UseCounterDecay`来关闭热度衰减，让方法调用次数统计变为绝对次数。

当一个方法被调用时，JVM先检查方法是否存在被即时编译器编译过的版本，如果存在则使用编译后的本地代码执行。如果不存在已编译过的版本，则将方法的计数器加1，然后判断计数器和回边计数器值的和是否超过方法调用计数器的阈值，如果超过阈值则向编译器提交一个该方法的代码编译请求。当编译工作完成后，方法调用入口地址就会被改成新的，下次调用该方法时就会使用已编译版本。

## 回边计数器

回边计数器用来统计一个方法中循环体的执行次数。用来触发栈上替换编译。

当解释器遇到一条回边指令，先查找将要执行的代码片段是否已有编译好的版本，如果有就优先执行已编译的代码。如果没有就把回边计数器值加1，然后判断方法调用计数器和回边计数器值的和是否超过回边计数器的阈值。如果超过阈值，将会提交一个栈上替换编译请求，并把回边计数器值稍微降低，以便继续在解释器中执行循环。



# 参考

- 《深入Java虚拟机》
- 《实战Java虚拟机 JVM故障诊断与性能优化》
- 《HotSpot实战》
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》
- 《Java虚拟机规范》
---
title: JVM中的锁使用过程
date: 2017-07-31 15:02:04
categories: 
	- JVM
tags:
	- JVM
---

JVM中的锁使用过程，从偏向锁到轻量级锁到重量级锁的过程。

<!--more-->

在获取锁的时候，如果几乎无竞争，则会使用偏向锁；锁竞争不多的情况下，会由偏向锁升级为轻量级锁；锁竞争严重的情况下，轻量级锁会膨胀为重量级索。

# 偏向锁

偏向锁是要把获取锁的线程的线程id写到锁对象头的Mark Word中去，表示这个线程占有了这个锁，或者这个锁偏向于这个线程。

- 锁对象头的Mark Word中锁标志位为01，偏向锁标志位为0，表示该对象未被锁定，并且禁止偏向。
- 锁对象头的Mark Word中锁标志位为01，偏向锁标志位为1，线程ID为null，意味着这个锁对象没有偏向任何一个线程。第一个获取锁对象的线程可使用CAS来获取该偏向锁。这种状态称为匿名偏向。
- 锁对象头的Mark Word中锁标志位为01，偏向锁标志位为1，线程ID不为null，epoch值有效（epoch值可参考批量重偏向相关的内容），意味着有其他线程在使用这个锁对象。这种状态称为已偏向。
- 锁对象头的Mark Word中锁标志位为01，偏向锁标志位为1，线程ID不为null，epoch值无效，下一个试图获取锁对象的线程，可使用CAS指令来获取该偏向锁。这种状态称为可重偏向。

## 偏向锁的获取

开始获取锁时，线程会先检测对象头的Mark Word中锁标志位是否是01，如果是01并且偏向锁标志位为0，表示禁止偏向，此时会直接升级轻量级锁。如果锁标志位是01且偏向锁标志位为1，则开始偏向锁的获取逻辑。

开始偏向锁获取，当前线程会检查对象头的Mark Word中的线程id是否是当前线程的线程id：

- 如果是当前线程的线程id，表明当前线程已经获取到锁对象，以后该线程进入同步块都不需要CAS进行加锁，只会往当前线程的栈中添加一条Displaced Mark Word为null的Lock Record，用来统计重入次数。退出同步块释放偏向锁时，依次删除对应的Lock Record，但不会修改对象头中的线程id
- 如果不是当前线程的线程id，当前线程进行CAS操作，试图将当前线程id写入到对象头的Mark Word中：
  - 如果当前锁对象处于匿名偏向状态，也就是处于可偏向但没有被偏向，这种情况会直接替换成功，将Mark Word中的线程id改为当前线程的线程id，并在当前线程栈中找到内存地址最高的可用Lock Record将线程id写入，此时当前线程获取到锁，可以执行同步代码块
  - 如果当前锁对象已经被其他线程占用，则CAS替换会失败，就开始偏向锁撤销。偏向锁一旦出现线程竞争，就会撤销偏向锁。偏向锁撤销需要等待全局安全点（Safe Point，这个状态下所有线程都是暂停的），暂停持有偏向锁的线程，检查持有偏向锁的线程状态：
    - 如果这个线程还存活，则检查线程是否在执行同步代码块中的代码，如果是的话则升级为轻量级锁，进行CAS竞争。
    - 如果这个线程不再活着或者线程存活但是没有在执行同步块中的代码，则校验是否允许重偏向，如果不允许重偏向，则撤销偏向锁，将Mark Word设置为无锁状态，也就是未锁定禁止偏向的状态，然后将线程升级为轻量级锁，当前线程进行CAS竞争；如果允许重偏向，设置为匿名偏向状态，也就是可偏向但没有被偏向，CAS将偏向锁指向当前线程。
    - 唤醒暂停的线程，从安全点继续执行代码。

每次进入同步块（即执行monitorenter）的时候都会以从高往低的顺序在栈中找到第一个可用的Lock Record，并设置偏向线程ID；每次解锁（即执行monitorexit）的时候都会从最低的一个Lock Record移除。所以如果能找到对应的Lock Record说明偏向的线程还在执行同步代码块中的代码。

## 偏向锁的撤销

偏向锁撤销是指在获取偏向锁的过程中，因不满足条件导致要将锁对象改为非偏向锁状态。一旦出现线程竞争，就会撤销偏向锁。偏向锁的撤销需要等待全局安全点（Safe Point，这个状态下所有线程都是暂停的），暂停持有偏向锁的线程，检查持有偏向锁的线程状态，如果这个线程还存活，则检查线程是否在执行同步代码块中的代码，如果是的话则升级为轻量级锁，进行CAS竞争。如果这个线程不再活着或者线程存活但是没有在执行同步块中的代码，则校验是否允许重偏向，如果不允许重偏向，则撤销偏向锁，将Mark Word设置为无锁状态，也就是未锁定禁止偏向的状态，然后升级为轻量级锁，进行CAS竞争；如果允许重偏向，设置为匿名偏向状态，也就是可偏向但没有被偏向，CAS将偏向锁指向当前线程。然后会唤醒暂停的线程，从安全点继续执行代码。

# 批量重偏向和批量撤销



# 参考

- 《实战Java虚拟机 JVM故障诊断与性能优化》
- 《HotSpot实战》
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》
- [https://blog.csdn.net/lengxiao1993/article/details/81568130](https://blog.csdn.net/lengxiao1993/article/details/81568130)
- [https://zhuanlan.zhihu.com/p/26475023](https://zhuanlan.zhihu.com/p/26475023)
- [https://my.oschina.net/u/3790005/blog/3036236](https://my.oschina.net/u/3790005/blog/3036236)